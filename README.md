# medical-expenses-simulator3.0
[README.md](https://github.com/user-attachments/files/23012363/README.md)
# 在宅医療・訪問看護費用シミュレーター（2024年度診療報酬改定対応）

特定医療法人 新生病院の在宅医療（訪問診療）・訪問看護にかかる月額費用を計算するWebアプリケーションです。

## 🚀 最新大型アップデート（2024年10月21日）

### ✅ 動的注釈変更バグ修正完了
**UI動的変更バグ修正（第18弾）:**
- **HTML構造修正**: 重複ID問題を解決（weeklyNursingVisitsContainerとweeklyNursingVisitsの分離）
- **DOM選択最適化**: 注釈要素に専用ID（weeklyNursingVisitsNote）を追加し、直接選択方式に変更
- **動的注釈変更完全対応**: 医療保険選択時に「※看護・リハの訪問頻度を選択」、その他では「※看護の訪問頻度を選択」の正確な切り替えを実現
- **JavaScript改善**: updateNursingVisitsLabel()メソッドの DOM 選択ロジックを改善し、確実な要素取得を実装

### ✅ 訪問看護UI最適化＆算定方式改善完了
**UI表示最適化・算定方式改善（第17弾）:**
- **医療保険時のUI簡素化**: 医療保険選択時は看護・リハビリの分離概念を削除し、週訪問回数フィールドに統合
- **ラベル・注釈動的変更機能**: 医療保険選択時に「（看護・リハ）週の訪問回数」「※看護・リハの訪問頻度を選択」、その他では「（看護）週の訪問回数」「※看護の訪問頻度を選択」の動的表示
- **介護保険時の加算項目適正化**: 介護保険選択時に医療DX（オンライン資格確認）加算を非表示
- **日曜日定期訪問の算定改善**: 週単位算定に変更し「30分/週×4週」の正確な月間計算を実装
- **患者タイプ別フィールド制御**: 各保険タイプに適した項目のみを表示する動的制御を強化
- **算定根拠の明確化**: 日曜日定期訪問で「○○分/週 × 4週」の詳細表示を追加

### ✅ 表示ロジック改善＆3区分内訳表示完了
**UI表示改善・計算ロジック透明化（第16弾）:**
- **カテゴリ別小計の表示改善**: 按分計算前の元の金額で表示（例：保険適用前10,000円→1割負担1,000円）
- **3区分内訳の明確化**: 月額利用料金内訳を「1.医療費」「2.介護保険費」「3.自費」の3区分で表示
- **高額療養費制度表記の追加**: 医療費項目に「高額療養費制度適用（上限額○○円）」を明記
- **計算ロジックの透明化**: 各カテゴリで通常の保険負担率計算を表示し、合算計算は最終内訳で適用
- **視認性の向上**: アイコンと色分けで3区分を明確に区別

### ✅ 3区分計算フロー対応＆医療費合算計算完了
**機能追加・計算フロー大幅改善（第15弾）:**
- **3区分計算フローの実装**: 医療費・介護保険費・自費を明確に区分して計算
- **医療保険合算計算の最適化**: 訪問診療と訪問看護の医療保険分を合算してから高額療養費制度を適用
- **低所得患者8,000円上限の正確な適用**: 70歳以上低所得Ⅰ・Ⅱの外来上限額を正確に反映
- **按分計算の実装**: 高額療養費適用後の金額を各サービスに正確に按分
- **合算負担率の保存**: 計算結果を各カテゴリで統一的に適用する仕組みを構築

### ✅ 高額療養費制度合算対応＆医療保険計算改善完了
**機能追加・計算精度向上（第14弾）:**
- **高額療養費制度の合算対応**: 訪問診療と訪問看護の医療保険分を合算して上限額を適用
- **訪問看護医療保険の段階的料金**: 週3日目まで5550円、週4日目以降6550円の正確な計算
- **医療保険UI最適化**: 医療保険選択時は訪問時間フィールドを非表示（一律料金のため）
- **合算負担率の適用**: 高額療養費適用後の負担率を訪問診療・訪問看護両方に適用
- **70歳以上上限額対応**: 在宅がん医療総合診療料の18,000円上限を訪問看護含めて適用

### ✅ UI表示改善＆日曜日訪問計算修正完了
**UI改善・計算ロジック修正（第13弾）:**
- **保険適用結果表示の削除**: 冗長な「保険適用結果」セクションを完全削除し、シンプルな表示に改善
- **日曜日定期訪問計算修正**: 訪問診療の訪問回数と独立した単発料金計算に修正（30分=1000円、60分=2000円）
- **表示の簡素化**: 不要な内訳表示を削除し、最終的な月額自己負担額のみに集約
- **計算ロジック最適化**: 訪問看護の自費部分計算を正確な単発料金方式に変更

### ✅ 在宅がん医療総合診療料自動設定＆月間訪問回数改善完了
**UI改善・自動化機能（第12弾）:**
- **在宅がん医療総合診療料自動設定**: 訪問診療で在宅がん医療総合診療料選択時に月間訪問日数を4日に自動設定
- **月間訪問日数の選択肢簡略化**: 1日/2日/3日/4日/4日以上の5択に改善（従来の15択から大幅簡略化）
- **バリデーション最適化**: 在宅がん医療総合診療料選択時は重症度を必須項目から除外、処方せん交付を必須に変更
- **ユーザビリティ向上**: 患者タイプに応じた適切な必須項目の動的制御
- **計算ボタン動作改善**: 患者タイプ別の必須項目条件分岐を最適化し、安定した動作を実現

### ✅ 計算ボタン不具合修正＆日曜日訪問算定改善完了
**バグ修正・機能改善（第11弾）:**
- **計算ボタン不具合完全修正**: JavaScriptのnullポインタエラーを解決、安全チェック強化
- **日曜日定期訪問算定修正**: 30分=1000円、60分=2000円の正確な算定方式に変更
- **UIテキスト最適化**: 「日曜日の定期訪問時間を選択（30分ごと、最大300分）」を「日曜日定期訪問」に簡略化
- **エラーハンドリング強化**: DOM要素の存在確認を徹底し、より安定した動作を実現
- **計算精度向上**: 自費部分の料金計算ロジックを明確化・正確化
- **動作確認済み**: 全機能の包括的テストを実施し、安定動作を確認

### ✅ サービス選択タブUI大幅刷新完了
**UI/UX改善（第10弾）:**
- **タブ形式のサービス選択**: 「利用する」「利用しない」をタブクリックで直感的に切り替え
- **強調色アクティブ表示**: 選択中のタブが緑色でハイライト表示され視認性向上
- **スマートな表示制御**: 「利用しない」選択時に関連フィールドが自動的に隠れる仕様
- **レスポンシブ対応**: モバイル・タブレット・PCで最適化されたタブレイアウト
- **既存機能完全統合**: チェックボックス機能をタブに統合し、後方互換性も維持
- **シームレス同期**: タブ状態と内部処理が完全同期する高品質UI実装

### ✅ 訪問看護フィールド構造大幅改善完了
**フィードバック対応（第9弾）:**
- **「看護タイプ」フィールド削除**: 煩雑な選択項目を除去しユーザビリティ向上
- **（看護）訪問時間独立設定**: 20分未満〜1時間以上（Ⅰ1〜Ⅰ4）の時間別料金対応
- **（看護）週回数独立設定**: 週1〜4回の詳細設定が可能
- **（リハ）訪問時間独立設定**: 20分・40分・60分（全てⅠ5扱い）の専用時間設定
- **（リハ）週回数独立設定**: 週1〜4回でリハビリ訪問頻度を個別管理
- **計算ロジック完全対応**: 看護・リハビリ別々の基本療養費計算を実装
- **バリデーション更新**: 新フィールド構造に完全対応した検証機能
- **動作確認済み**: シンタックスエラー修正を含む全面的なテスト完了

### ✅ 計算ボタン不具合完全修正完了
**バグ修正（第8弾）:**
- **重大バグ修正**: 患者タイプ統一後の計算ボタン動作停止問題を解決
- **データ参照修正**: 訪問診療料計算で「在がん」→「在宅がん医療総合診療料」への参照ミス修正
- **UI/UX改善**: 訪問看護フィールドのデフォルト表示機能を実装
- **バリデーション最適化**: フォーム検証フローを改善し、必須項目の可視性向上
- **ユーザビリティ強化**: 患者タイプ選択と同時に関連フィールドを自動表示

### ✅ 患者タイプ統一＆自動連動機能完了
**フィードバック対応（第7弾）:**
- 患者タイプ名称統一：「在がん」→「在宅がん医療総合診療料」に完全統一
- 自動連動機能追加：どちらか一方で「在宅がん医療総合診療料」選択時に相手方も自動選択
- ユーザビリティ向上：重複入力不要でスムーズな選択操作
- 一貫性確保：HTML・JavaScript全体で統一された名称使用
- エラー修正：変数重複宣言とスコープ問題を解決

### ✅ レイアウト改善＆UI最適化完了  
**フィードバック対応（第6弾）:**
- レイアウト構成の最適化：「シミュレーターについて」を最下部に移動
- 不要なセクション削除：「お問い合わせ」セクションを完全削除
- ユーザーフロー改善：計算→結果→比較→説明の自然な流れ
- 注意書き文言更新：お問い合わせへの言及を削除
- シンプルなページ構成：必要最小限の情報に集約

### ✅ プラン比較機能＆サービス選択改善完了  
**フィードバック対応（第5弾）:**
- プラン比較機能を実装：複数のプランを比較表で確認可能
- サービス選択方式を改善：「訪問診療＋訪問看護」固定で「利用しない」チェックボックス方式
- 比較表機能：複数パターンの料金比較を保険サンプル形式で表示
- 印刷機能拡張：個別計算結果＋比較表印刷機能
- 「別のプランと比較する」チェックボックス：計算結果横に配置
- プラン追加機能：現在の計算結果を比較データに蓄積
- 比較表表示：パターンA、パターンB...の横並び比較
- サービス無効化：利用しないサービスは¥0表示

### ✅ 計算結果表示の視覚的改善完了  
**フィードバック対応（第4弾）:**
- 訪問診療と訪問看護セクション間に明確な視覚的境界線を追加
- セクションタイトルに色分けされた背景（訪問診療：青、訪問看護：ピンク）とアイコン
- 月額利用料金内訳の表示形式を改善「訪問診療: ¥X、訪問看護: ¥Y、合計: ¥Z」
- セクション小計にグラデーション背景とカラーテーマを適用
- 合計表示エリアにアイコン付きの詳細内訳フォーマット

### ✅ フィードバック対応・訪問看護機能の完全改善  
**フィードバック対応（第3弾）:**
- 訪問看護の「看護ステーションからの距離」を全面削除（交通費発生しないため）
- 介護保険の加算をプルダウンからチェックボックスに変更（複数選択可能）
- 訪問看護カテゴリ内の「所得水準」項目を削除（共通の所得水準のみ残存）
- 医療保険のオンライン資格確認加算を医療保険加算内に統合
- 計算ロジックから訪問看護の交通費計算を完全除外

**フィードバック対応（第2弾）:**
- プルダウンメニュー上部の「ご利用サービス」を削除
- 小タイトルを「訪問診療」「訪問看護」に変更し、ピンク配色を追加
- 訪問看護の患者タイプ「在がん」選択時に自費部分のみ表示
- 患者タイプ「医療保険」選択時に訪問時間項目を非表示
- 週の訪問回数を「看護」「リハビリ」で分離して入力可能
- 医療保険の加算をチェックボックスで複数選択可能に変更
- 自費項目を「日曜日定期訪問」に変更し、30分ごとの選択肢（最大300分）
- 所得水準を共通項目としてサービス選択欄下部に配置

**初回フィードバック対応:**
- 「条件入力」→「ご利用サービス」に変更
- 訪問診療+訪問看護選択時の項目を区分けし、小タイトルで整理
- 添付資料に基づいた正確な訪問看護区分の実装

**新機能:** 訪問看護料金計算機能を追加し、訪問診療との合算も可能に  
**対応サービス:** 
- 訪問診療（従来機能）
- 訪問看護（新機能・添付資料準拠） 
- 訪問診療 + 訪問看護（合算計算）

**実装内容:**
- **プラン比較機能**：複数の料金計算パターンを保険会社スタイルの比較表で表示
- **新サービス選択方式**：「訪問診療＋訪問看護」固定＋「利用しない」チェックボックス
- **比較表印刷機能**：複数プランの詳細比較表を印刷可能
- **動的料金表示**：利用しないサービスは¥0で明確表示
- **プラン蓄積機能**：計算結果を「プラン1」「プラン2」として保存・比較
- **横並び比較表**：基本情報・料金内訳・合計金額を一覧比較

**従来機能:**
- サービス選択ドロップダウンによる動的フォーム表示
- 添付資料準拠の正確な訪問看護料金体系実装
- 患者タイプ別条件分岐（在がん：自費のみ、介護保険：交通費除外、医療保険：時間・交通費除外）
- 看護タイプ別料金（看護のみ・看護+セラピスト）
- 訪問時間別料金（20分未満〜1時間以上）※介護保険のみ
- 週の訪問回数を看護・リハビリで分離入力
- 介護保険の加算項目（チェックボックスで複数選択可能）
- 医療保険の加算項目（オンライン資格確認加算統合・チェックボックスで複数選択可能）
- 日曜日定期訪問（30分単位、最大300分まで）
- 訪問看護では交通費計算を完全除外
- ピンク配色による見やすい小タイトル
- 所得水準の共通項目化
- 合算計算時の適切な保険適用
- 印刷機能のサービス別対応

## 🔧 過去のアップデート（2024年10月10日）

### ✅ 印刷機能の保険負担割合表示修正完了
**問題:** 印刷された書類で保険負担割合が「30割負担」「10割負担」と誤表示されていた  
**修正:** 正しく「3割負担」「1割負担」と表示されるよう修正完了  
**対象ファイル:** `js/app.js` の `generatePrintContent()` 関数  
**修正内容:**
```javascript
// 修正前: formData.insuranceRate + "割負担"
// 修正後: Math.floor((formData.insuranceRate || 0) / 10) + "割負担"
```
**テスト:** 統合テストにより修正の動作確認済み

## 📋 プロジェクト概要

このシミュレーターは、2024年度診療報酬改定に基づく正確な料金体系で、患者様やご家族が在宅医療・訪問看護の費用を事前に把握できるよう開発されました。

## ✅ 実装済み機能

### 🏠 基本機能
- **マルチサービス対応**: 訪問診療・訪問看護・両方の合算計算が可能
- **正確な診療報酬計算**: 2024年度診療報酬改定に完全対応
- **サービス別料金表示**: 各サービスに応じた詳細内訳表示
- **動的フォーム**: サービス選択に応じてフォーム項目が自動切り替え
- **重症度対応**: 重症患者の高い料金設定に自動対応（訪問診療）
- **看護師区分対応**: 看護師・准看護師の適切な算定（訪問看護）
- **保険選択対応**: 医療保険・介護保険の選択機能（訪問看護）
- **レスポンシブデザイン**: PC・タブレット・スマートフォンに対応
- **印刷機能**: 計算結果をA4用紙1枚で印刷可能（サービス別対応）

### 🔢 4分野料金体系

#### 1. 在総管と加算（月額・保険適用）
**在宅時医学総合管理料：**
- **在総管1**: 同一日訪問患者1名
  - 月1回: 27,450円（2,745点）
  - 月2回以上（重症度なし）: 44,850円（4,485点）
  - 月2回以上（重症度あり）: 53,850円（5,385点）
- **在総管2-9**: 同一日訪問患者2-9名
  - 月1回: 14,850円（1,485点）
  - 月2回以上（重症度なし）: 23,850円（2,385点）
  - 月2回以上（重症度あり）: 44,850円（4,485点）
- **在総管10-19**: 同一日訪問患者10-19名
  - 月1回: 7,650円（765点）
  - 月2回以上（重症度なし）: 11,850円（1,185点）
  - 月2回以上（重症度あり）: 28,650円（2,865点）

**施設入居時等医学総合管理料：**
- **施設総管1**: 同一日訪問患者1名
  - 月1回: 19,650円（1,965点）
  - 月2回以上（重症度なし）: 31,850円（3,185点）
  - 月2回以上（重症度あり）: 38,850円（3,885点）
- **施設総管2-9**: 同一日訪問患者2-9名
  - 月1回: 10,650円（1,065点）
  - 月2回以上（重症度なし）: 16,850円（1,685点）
  - 月2回以上（重症度あり）: 32,250円（3,225点）
- **施設総管10-19**: 同一日訪問患者10-19名
  - 月1回: 7,650円（765点）
  - 月2回以上（重症度なし）: 11,850円（1,185点）
  - 月2回以上（重症度あり）: 28,650円（2,865点）

**在宅がん医療総合診療料：**
- **処方せん交付あり**: 17,980円/日 × 30日 = 539,400円/月（1,798点）
- **処方せん交付なし**: 20,000円/日 × 30日 = 600,000円/月（2,000点）
- **算定方式**: 1日あたりの料金を30日分で計算（訪問回数に関係なし）
- **70歳以上医療費上限額**: 月額18,000円
- **重症度分類**: なし（在総管との併用不可のため）
- **在宅患者訪問診療料**: 算定なし（在宅がん医療総合診療料に包括）

#### 2. 在宅患者訪問診療料（日額・保険適用）
- **単独訪問**: 8,880円/日（888点・同一日に1人のみ訪問）
- **複数患者訪問**: 2,030円/日（203点・同一日に2人以上訪問）

#### 3. 介護保険（居宅療養管理指導）
**月2回まで算定可能**（訪問回数が2回を超える場合も2回分のみ）：

**在宅がん医療総合診療料算定時**：
- **医師Ⅰ1（1人）**: 5,150円/回（515単位） × 最大2回
- **医師Ⅰ2（2-9人）**: 4,870円/回（487単位） × 最大2回
- **医師Ⅰ3（10人以上）**: 4,460円/回（446単位） × 最大2回

**それ以外（在総管・施設総管算定時）**：
- **医師Ⅱ1（1人）**: 2,990円/回（299単位） × 最大2回
- **医師Ⅱ2（2-9人）**: 2,870円/回（287単位） × 最大2回
- **医師Ⅱ3（10人以上）**: 2,600円/回（260単位） × 最大2回

**適用条件**: 
- 第1号被保険者（75歳以上）
- 第2号被保険者（40-64歳で要介護認定者）
- 介護保険サービス利用者（「あり」選択時のみ）

#### 4. 自費（交通費）
- **距離別交通費**（1回あたり、訪問回数で乗算）:
  - 4km未満: 無料
  - 4-6km: 509円/回
  - 6-8km: 1,019円/回
  - 8km以上: 1,528円/回

### 🩺 訪問看護料金体系

#### 1. 基本療養費（1回あたり・保険適用）
- **20分未満**: 3,130円（313点）
- **30分未満**: 4,670円（467点）
- **30分以上**: 5,710円（571点）
- **60分以上**: 8,420円（842点）
- **90分以上**: 11,420円（1,142点）

**准看護師による訪問**: 上記金額の90%算定

#### 2. 管理療養費（月額・保険適用）
- **機能強化型I**: 74,400円（7,440点）
- **機能強化型II**: 64,000円（6,400点）
- **機能強化型III**: 55,500円（5,550点）
- **その他**: 46,810円（4,681点）

#### 3. 特別管理加算（月額・保険適用）
- **特別管理加算I**: 50,000円（5,000点）
- **特別管理加算II**: 25,000円（2,500点）

**適用条件**: 在宅中心静脈栄養、在宅成分栄養経管栄養法等の管理が必要な場合

#### 4. 保険適用
- **医療保険**: 厚生労働大臣が定める疾病等又は急性増悪期等の場合
- **介護保険**: 要介護・要支援認定者の場合（原則）

#### 5. 自費（交通費）
- **訪問看護ステーションからの距離に応じた交通費**
- 計算方法は訪問診療と同様

### 💰 軽減措置対応
- **福祉医療費受給者証**: 50%軽減または上限1万円
- **難病指定**: 30%軽減または上限5千円
- **高額療養費制度**: 協会けんぽ基準による所得水準別上限額適用（2024年度対応）

#### 🏥 高額療養費制度（協会けんぽ基準・2024年度）

**69歳以下の自己負担上限額**：
- **区分ア（年収約1,160万円～）**: 252,600円 + (医療費 - 842,000円) × 1%
- **区分イ（年収約770～1,160万円）**: 167,400円 + (医療費 - 558,000円) × 1%
- **区分ウ（年収約370～770万円）**: 80,100円 + (医療費 - 267,000円) × 1%
- **区分エ（年収～370万円）**: 57,600円
- **区分オ（住民税非課税）**: 35,400円

**70-74歳の自己負担上限額**：
- **現役並み所得Ⅲ（課税所得690万円以上）**: 252,600円 + (医療費 - 842,000円) × 1%
- **現役並み所得Ⅱ（課税所得380万円以上）**: 167,400円 + (医療費 - 558,000円) × 1%
- **現役並み所得Ⅰ（課税所得145万円以上）**: 80,100円 + (医療費 - 267,000円) × 1%
- **一般（課税所得145万円未満）**: 57,600円（外来：14,000円）
- **低所得Ⅱ（住民税非課税）**: 24,600円
- **低所得Ⅰ（住民税非課税・年金収入80万円以下）**: 15,000円

**75歳以上の自己負担上限額**：
- **現役並み所得Ⅲ（課税所得690万円以上）**: 252,600円 + (医療費 - 842,000円) × 1%
- **現役並み所得Ⅱ（課税所得380万円以上）**: 167,400円 + (医療費 - 558,000円) × 1%
- **現役並み所得Ⅰ（課税所得145万円以上）**: 80,100円 + (医療費 - 267,000円) × 1%
- **一般（課税所得145万円未満）**: 57,600円（外来：14,000円）
- **低所得Ⅱ（住民税非課税）**: 24,600円
- **低所得Ⅰ（住民税非課税・年金収入80万円以下）**: 15,000円

### 📊 条件分岐要素
1. **患者タイプ**: 在宅がん医療総合診療料、在総管1/2-9/10-19、施設総管1/2-9/10-19
2. **重症度**: 重症度あり、重症度なし（在総管・施設総管のみ、在宅がん医療総合診療料は対象外）
3. **処方せん交付**: あり、なし（在宅がん医療総合診療料のみ）
4. **医療保険負担割合**: 1割、2割、3割
5. **介護保険サービス利用**: あり（要介護者・第2号被保険者）、なし
6. **介護保険負担割合**: 1割、2割、3割（サービス利用時のみ）
7. **所得水準（高額療養費制度）**: 協会けんぽ基準による年齢・所得区分
   - 69歳以下: 5区分（区分ア～オ）
   - 70-74歳: 6区分（現役並み所得Ⅰ～Ⅲ、一般、低所得Ⅰ・Ⅱ）
   - 75歳以上: 6区分（現役並み所得Ⅰ～Ⅲ、一般、低所得Ⅰ・Ⅱ）
8. **距離**: 4km未満～8km以上（4段階）
9. **月間訪問日数**: 1日～15日以上
10. **特別条件**: 福祉医療費受給者、難病指定

## 🗄️ データベース構造

### テーブル: `medical_fees`
診療報酬点数表データを管理
- 患者タイプ別の基本料金
- 重症度による料金差
- 距離・職員数による加算料金

### テーブル: `simulation_results` 
シミュレーション結果を記録
- 入力条件の履歴
- 4分野別計算結果と内訳
- 実行日時

## 🌐 公開URL

**本番環境**: デプロイ後にPublishタブで確認可能
**API エンドポイント**: 
- `GET /tables/medical_fees` - 料金表データ取得
- `POST /tables/simulation_results` - 結果保存

## 🚀 使用技術

### フロントエンド
- **HTML5**: セマンティックマークアップ
- **CSS3**: レスポンシブデザイン、4分野別表示スタイル
- **JavaScript ES6+**: 診療報酬計算ロジック、DOM操作
- **Google Fonts**: Noto Sans JP
- **Font Awesome**: アイコン表示

### バックエンド
- **RESTful Table API**: データの永続化
- **JSON**: データ交換形式

## 📱 レスポンシブ対応

- **デスクトップ**: 1200px以上
- **タブレット**: 768px-1199px
- **スマートフォン**: 767px以下

## 🔧 料金体系のカスタマイズ

### 診療報酬改定への対応
`js/app.js` の `medicalFees` オブジェクトで料金を更新:

```javascript
this.medicalFees = {
    在総管: {
        '在総管1': {
            normal: 53850,   // 5,385点×10円（正確な2024年度点数）
            severe: 53850,
            description: '在宅時医学総合管理料（同一日に訪問する患者が1人）'
        }
        // ...
    }
};
```

### 距離加算の調整
`distanceFees` 配列で距離別料金を変更可能

### 軽減措置の調整
`applyReductions` メソッドで各軽減措置の割合や上限額を調整可能

## 📋 重要な修正点

### 🔄 重要な修正点
1. **正確な診療報酬点数**: 2024年度改定の正確な点数に修正
   - 在総管1: 5,385点（旧:540.8点）
   - 訪問診療料: 888点（旧:83.3点）  
   - 居宅療養管理指導: 
     - 在宅がん算定時: Ⅰ1(1人)515単位、Ⅰ2(2-9人)487単位、Ⅰ3(10人以上)446単位
     - それ以外: Ⅱ1(1人)299単位、Ⅱ2(2-9人)287単位、Ⅱ3(10人以上)260単位
2. **在総管の正しい理解**: 「月間訪問回数」→「同一日あたり訪問患者数」
3. **4分野別表示**: 料金構成を明確に分離表示
4. **重症度加算**: 2回以上訪問時の正確な加算計算
5. **正確な交通費**: 4km未満無料、4-6km:509円、6-8km:1,019円、8km以上:1,528円
6. **介護保険適用の正確性**: 第2号被保険者（40歳以上の要介護者）にも対応
7. **保険負担割合の正確適用**: 医療保険・介護保険それぞれの負担割合を適用

### 🆕 最新の修正（2024年度診療報酬正確対応）
1. **在総管・施設総管の訪問回数別料金体系**: 月の訪問回数と重症度で正確な料金計算
   - **月1回**: 全ての在総管・施設総管で独自の低い点数
   - **月2回以上（重症度なし）**: 基本料金
   - **月2回以上（重症度あり）**: 重症加算適用
   
   **在総管の正確な点数：**
   - 在総管1: 月1回 2,745点 / 月2回以上(重症度なし) 4,485点 / 月2回以上(重症度あり) 5,385点
   - 在総管2-9: 月1回 1,485点 / 月2回以上(重症度なし) 2,385点 / 月2回以上(重症度あり) 4,485点
   - 在総管10-19: 月1回 765点 / 月2回以上(重症度なし) 1,185点 / 月2回以上(重症度あり) 2,865点
   
   **施設総管の正確な点数：**
   - 施設総管1: 月1回 1,965点 / 月2回以上(重症度なし) 3,185点 / 月2回以上(重症度あり) 3,885点
   - 施設総管2-9: 月1回 1,065点 / 月2回以上(重症度なし) 1,685点 / 月2回以上(重症度あり) 3,225点
   - 施設総管10-19: 月1回 765点 / 月2回以上(重症度なし) 1,185点 / 月2回以上(重症度あり) 2,865点
3. **在宅がん医療総合診療料の正確な算定**: 日額×30日制と処方せん交付の有無に対応
   - **患者タイプ**: 「在宅がん医療総合診療料」に変更（在総管との併用不可を明確化）
   - **重症度分類**: 在宅がん医療総合診療料選択時は重症度選択を非表示
   - **算定方式**: 1日あたりの料金×30日で計算（訪問回数に関係なし）
   - **処方せん交付あり**: 17,980円/日×30日 = 539,400円/月（1,798点）
   - **処方せん交付なし**: 20,000円/日×30日 = 600,000円/月（2,000点）
   - **70歳以上医療費上限額**: 月額18,000円
   - **在宅患者訪問診療料**: 算定なし（包括済み）
4. **居宅療養管理指導の月2回上限制**: 月2回まで算定可能（訪問回数が多くても2回分まで）
5. **介護保険サービス利用の選択肢**: 「あり」「なし」の2つの選択肢に対応
6. **NaNエラーの完全修正**: 計算・表示における全てのNaN発生を防止
7. **高額療養費制度の完全実装**: 協会けんぽ基準による年齢・所得水準別上限額の適用
   - **69歳以下**: 年収区分による5段階の上限額（区分ア～オ）
   - **70-74歳**: 現役並み所得3区分と一般・低所得2区分による6段階の上限額
   - **75歳以上**: 現役並み所得3区分と一般・低所得2区分による6段階の上限額
   - **計算式**: 80,100円+(医療費-267,000円)×1%等の正確な計算式を実装
   - **表示**: 高額療養費制度適用時の詳細表示（適用前→適用後の金額表示）
   - **年齢統合**: 年齢カテゴリを削除し、所得水準選択で年齢区分も同時選択
8. **正確な料金反映**: 患者数・在総管算定状況・重症度・訪問回数・処方せん交付・年齢・所得水準による上限額に応じた正確な料金計算

### 📊 計算結果の表示
- **分野1**: 在総管と加算（月額・保険適用）
- **分野2**: 在宅患者訪問診療料と加算（日額×訪問日数・保険適用）
- **分野3**: 介護保険（居宅療養管理指導）（日額×訪問日数・介護保険適用）
- **分野4**: 自費（交通費）（距離別料金×訪問日数・全額自己負担）

**最終料金**: 各分野に保険負担割合を適用後の自己負担額の合算

### 💰 保険適用の計算方式

**医療保険適用部分**：
- 在総管 + 在宅患者訪問診療料に医療保険負担割合（1-3割）を適用

**介護保険適用部分**：
- 居宅療養管理指導に介護保険負担割合（1-3割）を適用

**自費部分**：
- 交通費は全額自己負担（保険適用外）

**計算例1（在総管1・月1回・1割負担・距離4-6km）**：
```
【保険適用前】
1. 在総管1（月1回）: ¥27,450（医療保険・月額）
2. 訪問診療料: ¥8,880（医療保険・8,880円×1日）  
3. 居宅療養管理指導: ¥2,990（介護保険・Ⅱ1・299単位×1回・1人）
4. 交通費: ¥509（自費・509円×1回）
合計: ¥39,829

【保険適用後（自己負担額）】
1. 在総管1: ¥27,450 → ¥2,745（1割負担）
2. 訪問診療料: ¥8,880 → ¥888（1割負担）
3. 居宅療養管理指導: ¥2,990 → ¥299（1割負担）  
4. 交通費: ¥509（変更なし）
────────────────────
月額自己負担額: ¥4,441
```

**計算例2（在総管1・月2回以上・重症度なし・1割負担・距離4-6km）**：
```
【保険適用前】
1. 在総管1（月2回以上・重症度なし）: ¥44,850（医療保険・月額）
2. 訪問診療料: ¥17,760（医療保険・8,880円×2日）  
3. 居宅療養管理指導: ¥5,980（介護保険・Ⅱ1・299単位×2回・1人）
4. 交通費: ¥1,018（自費・509円×2回）
合計: ¥69,608

## 📊 3区分計算フローの詳細

### 🔍 新計算方式の概要
**2024年10月18日実装**の新しい3区分計算フローにより、医療費・介護保険費・自費を明確に区分し、医療保険分については合算してから高額療養費制度を適用する正確な計算を実現しています。

#### 計算の流れ
1. **費用区分の分類**
   - 医療保険適用分: 訪問診療全体 + 訪問看護（医療保険・在宅がん医療総合診療料分）
   - 介護保険適用分: 居宅療養管理指導 + 訪問看護（介護保険分）
   - 自費分: 交通費・日曜日定期訪問など

2. **医療保険合算計算**
   - 訪問診療と訪問看護の医療保険分を合算
   - 合算額に対して高額療養費制度の上限額を算出
   - 原則負担額が上限額を超えた場合、上限額を適用
   - 適用後の金額を各サービスに按分

3. **最終負担額算出**
   - 医療保険: 高額療養費適用後の患者負担額
   - 介護保険: 個別に負担割合（1-3割）を適用した患者負担額
   - 自費: 100%患者負担
   - 合計: 上記3区分の合算

#### 低所得患者への対応例
**70歳以上・低所得Ⅱ・在宅がん医療総合診療料 + 訪問看護（医療保険）**
```
【計算前】
1. 在宅がん医療総合診療料（処方せんあり）: ¥539,400/月
2. 訪問看護（医療保険・週1回×4週）: ¥22,200/月
医療保険合算前: ¥561,600

【3割負担計算前】¥168,480
【高額療養費上限】¥8,000（70歳以上・低所得Ⅱ・外来）
【適用後負担率】8,000 ÷ 561,600 ≒ 1.42%

【最終負担額】
- 在宅がん医療総合診療料: ¥539,400 × 1.42% ≒ ¥7,660
- 訪問看護: ¥22,200 × 1.42% ≒ ¥315
- 介護保険: なし
- 自費: ¥0
────────────────────
月額自己負担額: ¥8,000（上限額）
```

【保険適用後（自己負担額）】
1. 在総管1: ¥44,850 → ¥4,485（1割負担）
2. 訪問診療料: ¥17,760 → ¥1,776（1割負担）
3. 居宅療養管理指導: ¥5,980 → ¥598（1割負担）  
4. 交通費: ¥1,018（変更なし）
────────────────────
月額自己負担額: ¥7,877
```

**計算例3（在総管1・月2回以上・重症度あり・1割負担・距離4-6km）**：
```
【保険適用前】
1. 在総管1（月2回以上・重症度あり）: ¥53,850（医療保険・月額）
2. 訪問診療料: ¥17,760（医療保険・8,880円×2日）  
3. 居宅療養管理指導: ¥5,980（介護保険・Ⅱ1・299単位×2回・1人）
4. 交通費: ¥1,018（自費・509円×2回）
合計: ¥78,608

【保険適用後（自己負担額）】
1. 在総管1: ¥53,850 → ¥5,385（1割負担）
2. 訪問診療料: ¥17,760 → ¥1,776（1割負担）
3. 居宅療養管理指導: ¥5,980 → ¥598（1割負担）  
4. 交通費: ¥1,018（変更なし）
────────────────────
月額自己負担額: ¥8,777
```

**計算例（在総管1・重症度なし・月4回・1割負担・距離4-6km）**：
```
【保険適用前】
1. 在総管1（重症度なし）: ¥44,850（医療保険・月額）
2. 訪問診療料: ¥35,520（医療保険・8,880円×4日）  
3. 居宅療養管理指導: ¥5,980（介護保険・Ⅱ1・299単位×2回※上限・1人）
4. 交通費: ¥2,036（自費・509円×4回）
合計: ¥88,386

【保険適用後（自己負担額）】
1. 在総管1: ¥44,850 → ¥4,485（1割負担）
2. 訪問診療料: ¥35,520 → ¥3,552（1割負担）
3. 居宅療養管理指導: ¥5,980 → ¥598（1割負担）  
4. 交通費: ¥2,036（変更なし）
────────────────────
月額自己負担額: ¥10,671
```

**計算例（在総管2-9・重症度なし・月2回・1割負担・距離4-6km）**：
```
【保険適用前】
1. 在総管2-9（重症度なし）: ¥23,850（医療保険・月額）
2. 訪問診療料: ¥4,060（医療保険・2,030円×2日）  
3. 居宅療養管理指導: ¥5,740（介護保険・Ⅱ2・287単位×2回・2-9人）
4. 交通費: ¥1,018（自費・509円×2回）
合計: ¥34,668

【保険適用後（自己負担額）】
1. 在総管2-9: ¥23,850 → ¥2,385（1割負担）
2. 訪問診療料: ¥4,060 → ¥406（1割負担）
3. 居宅療養管理指導: ¥5,740 → ¥574（1割負担）  
4. 交通費: ¥1,018（変更なし）
────────────────────
月額自己負担額: ¥4,383
```

**計算例（施設総管1・月1回・1割負担・距離4-6km）**：
```
【保険適用前】
1. 施設総管1（月1回）: ¥19,650（医療保険・月額）
2. 訪問診療料: ¥8,880（医療保険・8,880円×1日）  
3. 居宅療養管理指導: ¥2,990（介護保険・Ⅱ1・299単位×1回・1人）
4. 交通費: ¥509（自費・509円×1回）
合計: ¥32,029

【保険適用後（自己負担額）】
1. 施設総管1: ¥19,650 → ¥1,965（1割負担）
2. 訪問診療料: ¥8,880 → ¥888（1割負担）
3. 居宅療養管理指導: ¥2,990 → ¥299（1割負担）  
4. 交通費: ¥509（変更なし）
────────────────────
月額自己負担額: ¥3,661
```

**計算例（在宅がん医療総合診療料・処方せん交付あり・月10回訪問・70歳以上1割負担・距離4-6km）**：
```
【保険適用前】
1. 在宅がん医療総合診療料: ¥539,400（医療保険・17,980円×30日）
2. 居宅療養管理指導: ¥10,300（介護保険・Ⅰ1・515単位×2回上限・通常）
3. 交通費: ¥5,090（自費・509円×10回）
合計: ¥554,790

【保険適用後（自己負担額）】
1. 在宅がん医療総合診療料: ¥539,400 → ¥18,000（70歳以上上限額適用）
2. 居宅療養管理指導: ¥10,300 → ¥1,030（1割負担）  
3. 交通費: ¥5,090（変更なし）
────────────────────
月額自己負担額: ¥24,120
```

**計算例（在宅がん医療総合診療料・処方せん交付なし・月5回訪問・69歳以下1割負担・距離4-6km）**：
```
【保険適用前】
1. 在宅がん医療総合診療料: ¥600,000（医療保険・20,000円×30日）
2. 居宅療養管理指導: ¥10,300（介護保険・Ⅰ1・515単位×2回上限・通常）
3. 交通費: ¥2,545（自費・509円×5回）
合計: ¥612,845

【保険適用後（自己負担額）】
1. 在宅がん医療総合診療料: ¥600,000 → ¥60,000（1割負担）
2. 居宅療養管理指導: ¥10,300 → ¥1,030（1割負担）  
3. 交通費: ¥2,545（変更なし）
────────────────────
月額自己負担額: ¥63,575
```

### 🖨️ 印刷機能

**特徴**:
- **A4用紙1枚対応**: 計算結果が1枚に収まるよう最適化
- **病院ヘッダー**: 新生病院の正式名称とロゴ的デザイン
- **計算条件表示**: 入力された条件を一覧で表示
- **詳細内訳**: 4分野別の料金内訳を見やすく配置
- **高額療養費制度表示**: 適用時のハイライト表示
- **免責事項**: 適切な注意事項を記載
- **日時記録**: 計算実行日時をフッターに表示

**使用方法**:
1. 料金計算を実行後、「計算結果を印刷する」ボタンが表示
2. ボタンクリックで印刷プレビューが自動的に開く
3. A4用紙で適切にレイアウトされた結果を印刷

## 🎯 推奨次ステップ

1. **実地での料金検証**: 実際の診療報酬請求との照合
2. **地域係数対応**: 地域別の診療報酬係数への対応
3. **加算項目の拡張**: 夜間・休日・緊急時加算の追加
4. **管理機能**: 料金表の動的更新機能

## 🛠️ 開発・テスト

### ファイル構造
```bash
├── index.html          # メインページ（修正済み）
├── css/
│   └── style.css      # 4分野表示対応スタイル
├── js/
│   └── app.js         # 2024年度診療報酬対応ロジック
└── README.md          # 更新済みプロジェクト説明
```

### 動作確認項目
1. 各患者タイプでの正確な計算
2. 重症度加算の適用確認
3. 4分野別料金の正確な表示
4. 保険適用・軽減措置の計算検証
5. レスポンシブデザインの確認

## 📞 お問い合わせ

**特定医療法人　新生病院**
- 在宅医療についてのご相談は病院までお電話ください
- 受付時間：平日 9:00-17:00

## ⚠️ 免責事項

このシミュレーターは2024年度診療報酬改定に基づく概算料金を表示するものです。実際の料金は以下により変動する場合があります：
- 個別の診療内容・検査・処置
- 地域係数や施設基準
- 保険適用状況の個別判定
- その他の加算項目

詳細は医療機関にお問い合わせください。

## 🔧 開発・技術情報

### 最新バグ修正詳細（2024/10/17）
**問題**: 患者タイプ名称統一後、計算ボタンが作動しない問題が発生

**原因分析**:
1. `calculateHomeMedicalFees()`関数内で古い患者タイプ名`'在がん'`を参照
2. 訪問看護必須フィールドがデフォルトで非表示のためバリデーション失敗
3. フォーム検証で訪問看護フィールド（`nursingType`、`nursingDuration`、`weeklyNursingVisits`）が未入力扱い

**修正内容**:
1. **データ参照修正**: Line 640の患者タイプ判定を`'在がん'` → `'在宅がん医療総合診療料'`に修正
2. **UI改善**: `handleNursingPatientTypeChange()`で未選択時にも基本フィールドを表示
3. **初期化処理**: ページロード時に訪問看護フィールド表示処理を実行

**テスト結果**: 全ての患者タイプパターンで計算実行を確認済み

### 技術スタック
- **Frontend**: HTML5, CSS3, Vanilla JavaScript
- **Styling**: Font Awesome, Google Fonts (Noto Sans JP)
- **Architecture**: クラスベース設計、イベント駆動型
- **Data**: RESTful Table API対応
- **Print**: A4最適化CSS、ブラウザ印刷API

---

*2024年度診療報酬改定対応版 - 正確な料金体系による信頼性の高いシミュレーション*
